!function(){"use strict";Function.prototype.bind||(Function.prototype.bind=function(t){var e,n,i=this;if("function"!=typeof i)throw new TypeError;return e=Array.prototype.slice.call(arguments,1),n=function(){if(this instanceof n){var s,r,o;return s=function(){},s.prototype=i.prototype,r=new s,o=i.apply(r,e.concat(Array.prototype.slice.call(arguments))),Object(o)===o?o:r}return i.apply(t,e.concat(Array.prototype.slice.call(arguments)))}})}(),function(t,e){"use strict";var n=function(t){this.handshakeId=t||"Bellhop",this.onReceive=null,this.target=null,this.connected=!1,this.name="",this.isChild=!0,this.connecting=!1,this.origin="*",this._listeners={},this._sendLater=[],this.supported=null},i=n.prototype={};n.VERSION="1.0.2",n.CONNECTED="connected",n.FAILED="failed",i.receive=function(t){var e,i,s=t.data;if(s==this.handshakeId){if(this.connecting=!1,this.connected=!0,this.trigger(n.CONNECTED),this.isChild||this.target.postMessage(s,this.origin),i=this._sendLater.length,i>0){for(e=0;i>e;e++){var r=this._sendLater[e];this.send(r.type,r.data)}this._sendLater.length=0}}else{if(!this.connected)return;if(s=JSON.parse(s),"object"!=typeof s)throw"The event received must be an object";if(!s.type)throw"The event received must contain a type";this.trigger(s)}},i.trigger=function(t){"string"==typeof t&&(t={type:t});var n=this._listeners[t.type];if(n!==e)for(var i=0,s=n.length;s>i;i++)n[i](t)},i.toString=function(){return"[Bellhop '"+this.name+"']"},i.connect=function(n,i){if(this.connecting)return this;this.connecting=!0;var s=this.isChild=n===e,r=this.target=s?t.top:n.contentWindow||n;if(this.supported=s?!!r&&t!=r:!!r,this.origin=i===e?"*":i,this.onReceive=this.receive.bind(this),t.attachEvent?t.attachEvent("onmessage",this.onReceive):t.addEventListener("message",this.onReceive),s)if(window===r)this.connecting=!1,this.connected=!1;else{var o=this;t.onload=function(){r.postMessage(o.handshakeId,o.origin)}}return this},i.disconnect=function(){return this.connected=!1,this.connecting=!1,this.origin=null,this.target=null,this._listeners={},this._sendLater.length=0,this.isChild=!0,t.detachEvent?t.detachEvent("onmessage",this.onReceive):t.removeEventListener("message",this.onReceive),this.onReceive=null,this},i.on=function(t,n){if("string"!=typeof t)for(var i in t)this.on(i,t[i]);else for(var s=t.split(" "),r=0,o=s.length;o>r;r++)t=s[r],this._listeners[t]===e&&(this._listeners[t]=[]),this._listeners[t].push(n);return this},i.off=function(t,n){if(this._listeners[t]===e)return this;if(n===e)delete this._listeners[t];else for(var i=this._listeners[t],s=0,r=i.length;r>s;s++)if(i[s]===n){i.splice(s,1);break}return this},i.send=function(t,n){if("string"!=typeof t)throw"The event type must be a string";if(t={type:t},n!==e&&(t.data=n),this.connecting)this._sendLater.push(t);else{if(!this.connected)return this;this.target.postMessage(JSON.stringify(t),this.origin)}return this},i.fetch=function(t,n,i,s){var r=this;if(!this.connecting&&!this.connected)throw"No connection, please call connect() first";s=s===e?!1:s;var o=function(t){s&&r.off(t.type,o),n(t)};return this.on(t,o),this.send(t,i),this},i.respond=function(t,n,i){i=i===e?!1:i;var s=this,r=function(e){i&&s.off(e.type,r),s.send(t,n)};return this.on(t,r),this},i.destroy=function(){this.disconnect(),this._listeners=null,this._sendLater=null},t.Bellhop=n}(window);