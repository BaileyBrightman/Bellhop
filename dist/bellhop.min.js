/*! Bellhop 1.0.4 */
!function(){"use strict";!function(a,b){"use strict";var c=function(a){this.handshakeId=a||"Bellhop",this.onReceive=this.receive.bind(this),this.target=null,this.connected=!1,this.name="",this.isChild=!0,this.connecting=!1,this.origin="*",this._listeners={},this._sendLater=[],this.supported=null},d=c.prototype={};d.receive=function(a){var b=a.data;if(b==this.handshakeId){this.connecting=!1,this.connected=!0,this.trigger("connected"),this.isChild||this.target.postMessage(b,this.origin);var c,d=this._sendLater.length;if(d>0){for(c=0;d>c;c++){var e=this._sendLater[c];this.send(e.type,e.data)}this._sendLater.length=0}}else{if(!this.connected)return;try{b=JSON.parse(b)}catch(f){return}"object"==typeof b&&b.type&&b.channel==this.handshakeId&&this.trigger(b)}},d.trigger=function(a){"string"==typeof a&&(a={type:a});var c=this._listeners[a.type];if(c!==b)for(var d=0,e=c.length;e>d;d++)c[d](a)},d.toString=function(){return"[Bellhop '"+this.name+"']"},d.connect=function(c,d){if(this.connecting)return this;this.connecting=!0;var e=this.isChild=c===b,f=this.target=e?a.top:c.contentWindow||c;return this.supported=e?!!f&&a!=f:!!f,this.origin=d===b?"*":d,a.attachEvent?a.attachEvent("onmessage",this.onReceive):a.addEventListener("message",this.onReceive),e&&(a===f?(this.trigger("failed"),this.disconnect()):a.onload=function(){f.postMessage(this.handshakeId,this.origin)}.bind(this)),this},d.disconnect=function(){return this.connected=!1,this.connecting=!1,this.origin=null,this.target=null,this._listeners={},this._sendLater.length=0,this.isChild=!0,a.detachEvent?a.detachEvent("onmessage",this.onReceive):a.removeEventListener("message",this.onReceive),this},d.on=function(a,c){if("string"!=typeof a)for(var d in a)this.on(d,a[d]);else for(var e=a.split(" "),f=0,g=e.length;g>f;f++)a=e[f],this._listeners[a]===b&&(this._listeners[a]=[]),this._listeners[a].push(c);return this},d.off=function(a,c){if(this._listeners[a]===b)return this;if(c===b)delete this._listeners[a];else for(var d=this._listeners[a],e=0,f=d.length;f>e;e++)if(d[e]===c){d.splice(e,1);break}return this},d.send=function(a,c){if("string"!=typeof a)throw"The event type must be a string";if(a={type:a,channel:this.handshakeId},c!==b&&(a.data=c),this.connecting)this._sendLater.push(a);else{if(!this.connected)return this;this.target.postMessage(JSON.stringify(a),this.origin)}return this},d.fetch=function(a,c,d,e){var f=this;if(!this.connecting&&!this.connected)throw"No connection, please call connect() first";e=e===b?!1:e;var g=function(a){e&&f.off(a.type,g),c(a)};return this.on(a,g),this.send(a,d),this},d.respond=function(a,c,d){d=d===b?!1:d;var e=this,f=function(b){d&&e.off(b.type,f),e.send(a,c)};return this.on(a,f),this},d.destroy=function(){this.disconnect(),this._listeners=null,this._sendLater=null},a.Bellhop=c}(window);}();